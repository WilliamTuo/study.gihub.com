<html>
<head>
  <title>影响一个应用程序性能的因素有很多，这次说说page fault。</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600240 (zh-CN, DDL); Windows/6.1.1 (Win32);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1609"/>
<h1>影响一个应用程序性能的因素有很多，这次说说page fault。</h1>

<div><span><div><p style="margin: 0px; padding: 0px; font-weight: normal; color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">影响一个应用程序性能的因素有很多，这次说说page fault。</p><p style="margin: 0px; padding: 0px; font-weight: normal; color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">1. 为什么会存在page fault问题？</p><p style="margin: 0px; padding: 0px; font-weight: normal; color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">计算机的物理内存（看看你的内存条）有限，一般现在都是几个GB的容量了，BTW，我的笔记本有8GB，:-)。</p><p style="margin: 0px; padding: 0px; font-weight: normal; color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">但应用程序的需求是无限的，操作系统为了解决这个矛盾，使用了虚拟内存的设计。简单的描述就是，给应用程序</p><p style="margin: 0px; padding: 0px; font-weight: normal; color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">一个与物理内存无关的虚拟地址空间，并提供一套映射机制，将虚拟地址映射到物理内存。当然应用程序是不知道</p><p style="margin: 0px; padding: 0px; font-weight: normal; color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">有这个映射机制存在的，他唯一需要做的就是尽情的使用自己的虚拟地址空间。操作系统提供的映射机制是</p><p style="margin: 0px; padding: 0px; font-weight: normal; color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">运行时动态进行虚拟地址和物理地址之间的映射的，当一个虚拟地址没有对应的物理内存时候，</p><p style="margin: 0px; padding: 0px; font-weight: normal; color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">映射机制就分配物理内存，构建映射表，满足应用程序的需求，这个过程就叫page fault。</p><p style="margin: 0px; padding: 0px; font-weight: normal; color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">与直接访问物理内存不同，page fault过程大部分是由软件完成的，消耗时间比较久，所以是影响性能的一个关键指标。</p><p style="margin: 0px; padding: 0px; font-weight: normal; color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">Linux把page fault又进一步分为minor page fault和major page fault。前面提到的分配物理内存，构建映射表过程可以看做是</p><p style="margin: 0px; padding: 0px; font-weight: normal; color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">minor page fault。major page fault是由swap机制引入的，对于swap情况，地址映射好了后，还需要从外部存储读取数据，这个</p><p style="margin: 0px; padding: 0px; font-weight: normal; color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">过程涉及到IO操作，耗时更久。</p><p style="margin: 0px; padding: 0px; font-weight: normal; color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">2. 如何查看应用程序的page fault指标呢？</p><p style="margin: 0px; padding: 0px; font-weight: normal; color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">1） 可以使用time命令：</p><p style="margin: 0px; padding: 0px; font-weight: normal; color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">     比如我想看看svm-train的情况（模型训练很耗资源）\time svm-train age_train_equal.txt（前面的斜杠表示不使用shell的内嵌time命令）</p><p style="margin: 0px; padding: 0px; font-weight: normal; color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">输出是：7.68user 0.02system 0:07.71elapsed 99%CPU (0avgtext+0avgdata 42768maxresident)k</p><p style="margin: 0px; padding: 0px; font-weight: normal; color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">              0inputs+6696outputs (0major+15445minor)pagefaults 0swaps</p><p style="margin: 0px; padding: 0px; font-weight: normal; color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">可以看到只有minor page fault，没有major。</p><p style="margin: 0px; padding: 0px; font-weight: normal; color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">time命令的实现是用到了Linux提供的rusage机制。Linux的wait API可以返回一个应用程序的运行过程的资源消耗情况。</p><p style="margin: 0px; padding: 0px; font-weight: normal; color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">如果你想在自己的代码中获取资源利用情况，可以使用libc的getrusage函数，这个函数也是内核的API。</p><p style="margin: 0px; padding: 0px; font-weight: normal; color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">2） proc文件系统</p><div style="color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><div>Linux系统下的/proc/PID/stat文件，也提供了相关统计数据。</div></div><div style="color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><div><br/></div><div> http://www.cnblogs.com/cornsea/archive/2012/12/17/2821429.html</div></div></div></span>
</div></body></html> 